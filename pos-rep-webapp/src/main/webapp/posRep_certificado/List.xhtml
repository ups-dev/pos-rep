<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:us="http://ups.edu.ec/ui/security"
                xmlns:u="http://ups.edu.ec/ui"
                xmlns:o="http://omnifaces.org/ui">

    <f:metadata>
        <o:importConstants type="ec.edu.ups.pos.rep.data.utils.PosRepConstants"/>
    </f:metadata>

    <h:form id="PosReportesCerForm">
        <u:verticalStack gapXs="3">

            <p:messages id="listMessages" closable="true">
                <p:effect type="pulsate" event="load" delay="200" speed="500">
                    <f:param name="times" value="1"/>
                </p:effect>
            </p:messages>

            <u:card id="RepCabecera">
                <u:verticalStack gapXs="3">

                    <p:toolbar id="informesToolbar">
                        <p:toolbarGroup align="left">

                            <us:auth permissions="{'operations':['GENERAR']}">
                                <p:commandButton id="exportExcel"
                                                 icon="fa fa-file"
                                                 value="#{posRepBundle['ExportXls']}"
                                                 ajax="false"
                                                 process="@this"
                                                 update="messagePanel"
                                                 onclick="PrimeFaces.monitorDownload(start, stop);"
                                                 disabled="#{repReportesSistemaController.selected.resFormato eq null or (repReportesSistemaController.selected.resFormato ne 'EXCEL' and repReportesSistemaController.selected.resFormato ne 'PDF - EXCEL')}"
                                >
                                    <p:fileDownload
                                            value="#{posRepGeneralController.generar_reporte_certificado('xlsx',posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION))}"/>
                                </p:commandButton>
                            </us:auth>


                            <us:auth permissions="{'operations':['GENERAR']}">
                                <p:commandButton id="exportPdf"
                                                 style="margin-left: 40px"
                                                 icon="fa fa-file-pdf"
                                                 value="#{posRepBundle['ExportPdf']}"
                                                 ajax="false"
                                                 process="@this"
                                                 update="messagePanel"
                                                 onclick="PrimeFaces.monitorDownload(start, stop);"
                                                 disabled="#{repReportesSistemaController.selected.resFormato eq null or (repReportesSistemaController.selected.resFormato ne 'PDF' and repReportesSistemaController.selected.resFormato ne 'PDF - EXCEL')
                                       or empty posRepPosgradosController.insAlumnoWrapper
                                       or empty posRepPosgradosController.posgradoAlumnoWrapper
                                       or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'N')}">
                                    <p:fileDownload
                                            value="#{posRepGeneralController.generar_reporte_certificado('pdf',posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION))}"/>
                                </p:commandButton>
                            </us:auth>
                        </p:toolbarGroup>
                    </p:toolbar>

                    <p:dataTable id="PosReportesCerSistemaDataTable"
                                 widgetVar="PosReportesCerSistemaDataTableVar"
                                 value="#{repReportesSistemaController.items}"
                                 var="item"
                                 rowKey="#{item.resCodigo}"
                                 sortBy="#{item.resReporte}"
                                 sortOrder="ascending"
                                 paginator="true"
                                 rows="10"
                                 rowsPerPageTemplate="10,20,30,40,50"
                                 selectionMode="single"
                                 paginatorPosition="bottom"
                                 emptyMessage="#{posRepBundle['TableEmpty']}"
                                 selection="#{repReportesSistemaController.selected}"
                                 filteredValue="#{repReportesSistemaController.itemsFilter}">
                        <p:ajax event="rowSelect" update="
                                                  :PosReportesCerForm:informesToolbar,
                                                  :PosReportesCerForm:PosRepFiltroPanel,
                                                  :PosReportesCerForm:listMessages,
                                                  :PosReportesCerForm:alumno,
                                                  :PosReportesCerForm:semestre
                                                  :PosReportesCerForm:panelDataTable,
                                                  :PosReportesCerForm:PosRepFiltroPanel2,
                                                  :PosReportesCerForm:posRepFiltrarCampusEmision,
                                                  :PosReportesCerForm:posRepFiltrarSedeEmision"
                                listener="#{posRepPosgradosController.limpiarFiltros()}"/>

                        <p:ajax event="filter" update="
                                                :PosReportesCerForm:informesToolbar,
                                                :PosReportesCerForm:PosRepFiltroPanel,
                                                :PosReportesCerForm:listMessages,
                                                  :PosReportesCerForm:alumno,
                                                  :PosReportesCerForm:semestre,
                                                  :PosReportesCerForm:panelDataTable,
                                                  :PosReportesCerForm:PosRepFiltroPanel2,
                                                 :PosReportesCerForm:posRepFiltrarCampusEmision,
                                                  :PosReportesCerForm:posRepFiltrarSedeEmision"
                                listener="#{repReportesSistemaController.setSelected(null)}"/>

                        <p:column sortBy="#{item.resReporte}" filterBy="#{item.resReporte}" filterMatchMode="contains">
                            <f:facet name="header">
                                <h:outputText value="#{posRepBundle['RepReportesSistemaLabel_resReporte']}"/>
                            </f:facet>
                            <h:outputText value="#{item.resReporte}"/>
                        </p:column>

                    </p:dataTable>

                    <p:panel  id="PosRepFiltroPanel"  header="#{posRepBundle['PosRepParametros']}">

                        <u:grid columnsXs="1" columnsMd="1" columnsLg="1">

                            <h:panelGroup id="alumno" rendered="#{repReportesSistemaController.selected ne null
                                             and posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_ALUMNO)}">
                                <!--Filtro Estudiante-->
                                <u:formField label="#{posRepBundle['PosRepEstudiante']}:" autoWidth="false">

                                    <p:autoComplete id="posRepFiltrarEstudiante2"
                                                    value="#{posRepPosgradosController.insAlumnoWrapper}"
                                                    cache="true" forceSelection="true" maxResults="10"
                                                    minQueryLength="2"
                                                    cacheTimeout="30000"
                                                    var="p"
                                                    itemLabel="#{not empty p?p.cllcRuc:''}#{not empty p?' - ':''}#{not empty p?p.aluNombres:''}"
                                                    itemValue="#{p}"
                                                    autocomplete="on"
                                                    completeMethod="#{posRepPosgradosController.autoCompleteAlumnos}"
                                                    queryDelay="0"
                                    >
                                        <o:converter converterId="omnifaces.ListConverter"
                                                     list="#{posRepPosgradosController.listadoAlumnos}"/>

                                        <p:column>
                                            <h:outputText value="#{p.cllcRuc}"/>
                                            <h:outputText value="#{p.cllcRuc}"/>
                                        </p:column>
                                        <p:column>
                                            <h:outputText value="#{p.aluNombres}"/>
                                        </p:column>
                                        <p:ajax event="itemSelect"
                                                update="panelDataTable,semestre,PosRepFiltroPanel2, listMessages,posRepFiltrarCampusEmision, posRepFiltrarSedeEmision"
                                                listener="#{posRepPosgradosController.cargarLista()}"/>
                                        <p:ajax event="change"
                                                update="panelDataTable,semestre,PosRepFiltroPanel2, listMessages,posRepFiltrarCampusEmision, posRepFiltrarSedeEmision"
                                                listener="#{posRepPosgradosController.cargarLista()}"/>

                                    </p:autoComplete>
                                    <p:watermark
                                            value="#{posRepBundle['PosRepNombreApellido']}"
                                            for="posRepFiltrarEstudiante2"/>

                                </u:formField>
                            </h:panelGroup>

                            <h:panelGroup id="semestre" rendered="#{repReportesSistemaController.selected ne null
                                             and posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_SEMESTRE)
                                             and not empty posRepPosgradosController.insAlumnoWrapper}">

                                <u:formField label="#{posRepBundle['PosRepSemestre']}: *" for="posRepFiltrarNivel">

                                    <p:selectOneMenu id="posRepFiltrarNivel" autoWidth="false"
                                                     value="#{posRepPosgradosController.matNivelPeriodoEstructura}"
                                                     filter="true" filterMatchMode="contains" var="filtro"
                                    >
                                        <f:selectItem itemLabel="#{posRepBundle['SelectOneMessage']}" itemValue=""/>
                                        <f:selectItems
                                                value="#{posRepPosgradosController.matNivelPeriodoEstructuraList}"
                                                var="nivelMatriculaItem"
                                                itemValue="#{nivelMatriculaItem}"
                                                itemLabel="#{nivelMatriculaItem.toString()}"
                                        />
                                        <p:column>
                                            <h:outputText value="#{filtro}"/>
                                        </p:column>
                                        <p:ajax update="PosRepFiltroPanel2, listMessages"
                                                listener="#{posRepPosgradosController.actualizaCamposFac()}"/>

                                    </p:selectOneMenu>
                                </u:formField>

                            </h:panelGroup>

                            <h:panelGrid id="panelDataTable">
                                <p:dataTable id="PosgradosDataTable"
                                             widgetVar="PosgradosDataTableVar"
                                             value="#{posRepPosgradosController.listadoPosgrados}"
                                             var="item"
                                             rowKey="#{item.identificador}"
                                             sortBy="#{item.aluCodigo}"
                                             sortOrder="ascending"
                                             paginator="true"
                                             rows="10"
                                             rowsPerPageTemplate="10,20,30,40,50"
                                             selectionMode="single"
                                             selection="#{posRepPosgradosController.posgradoAlumnoWrapper}"
                                             paginatorPosition="bottom"
                                             emptyMessage="#{posRepBundle['TableEmpty']}"
                                             rendered="#{posRepPosgradosController.insAlumnoWrapper ne null}"
                                >
                                    <p:ajax event="rowSelect"
                                            listener="#{posRepPosgradosController.cargarValidaciones(repReportesSistemaController.selected)}"
                                            update=":PosReportesCerForm:semestre,:PosReportesCerForm:PosRepFiltroPanel2,:PosReportesCerForm:informesToolbar,
                                                                                                                                                    :PosReportesCerForm:listMessages, :PosReportesCerForm:posRepFiltrarCampusEmision,:PosReportesCerForm:posRepFiltrarSedeEmision"/>

                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Sede"/>
                                        </f:facet>
                                        <h:outputText value="#{item.sede}"/>
                                    </p:column>
                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Campus"/>
                                        </f:facet>
                                        <h:outputText value="#{item.campus}"/>

                                    </p:column>
                                    <p:column width="20%">
                                        <f:facet name="header">
                                            <h:outputText value="Programa"/>
                                        </f:facet>
                                        <h:outputText value="#{item.posgrado}"/>
                                    </p:column>
                                    <p:column width="20%">
                                        <f:facet name="header">
                                            <h:outputText value="Proyecto"/>
                                        </f:facet>
                                        <h:outputText value="#{item.proyecto}"/>
                                    </p:column>
                                    <p:column>
                                        <f:facet name="header">
                                            <h:outputText value="Modalidad"/>
                                        </f:facet>
                                        <h:outputText value="#{item.modalidad}"/>
                                    </p:column>
                                    <p:column width="14%">
                                        <f:facet name="header">
                                            <h:outputText value="Cohorte"/>
                                        </f:facet>
                                        <h:outputText value="#{item.cohorte}"/>
                                    </p:column>
                                    <p:column width="20%">
                                        <f:facet name="header">
                                            <h:outputText value="Título"/>
                                        </f:facet>
                                        <h:outputText value="#{item.titulo}"/>
                                    </p:column>
                                    <p:column width="5%">
                                        <f:facet name="header">
                                            <h:outputText value="Vigencia"/>
                                        </f:facet>
                                        <h:outputText value="#{item.vigencia}"/>
                                    </p:column>
                                </p:dataTable>
                                <br/>
                            </h:panelGrid>
                        </u:grid>

                    </p:panel>

                    <!--CERTIFICACIÓN -->
                    <p:panel  id="PosRepFiltroPanel2"  header="#{posRepBundle['PosRepEspecificos']}">
                        
                        <h:panelGroup id="datosfactura" rendered="#{not empty posRepPosgradosController.insAlumnoWrapper
                                                                                and not empty posRepPosgradosController.posgradoAlumnoWrapper
                                                                                and ( (posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION) and repReportesSistemaController.selected.resCodigo ne PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS)
                                                                                or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'S' ))
                                                                                }">

                            <u:grid columnsXs="1" columnsMd="2" columnsLg="3">

                                <u:formField>

                                    <p:outputLabel value="#{posRepBundle['PosRepSede']}:" for="sedeFacturacion"/>
                                    <p:inputText id="sedeFacturacion" value="#{posRepPosgradosController.sedeFactura}"
                                                 required="true"

                                                 requiredMessage="#{posRepBundle['PosRepSedeFacturacion']}"/>
                                </u:formField>


                                <u:formField>
                                    <p:outputLabel value="#{posRepBundle['PosRepPuntoFac']}:" for="puntoFacturacion"/>
                                    <p:inputText id="puntoFacturacion"
                                                 value="#{posRepPosgradosController.puntoFacturacion}"
                                                 required="true"
                                                 requiredMessage="#{posRepBundle['PosRepPuntoFacturacion']}"/>
                                </u:formField>


                                <u:formField>
                                    <p:outputLabel value="#{posRepBundle['PosRepNumFac']}:" for="numFactura"/>

                                    <p:inputText id="numFactura" value="#{posRepPosgradosController.numFactura}"
                                                 required="true"
                                                 requiredMessage="#{posRepBundle['PosRepNumeroFacturacion']}"/>
                                </u:formField>


                                <h:panelGroup id="sedeEmision"
                                              rendered="#{repReportesSistemaController.selected ne null }">
                                    <!--Filtro Sede-->
                                    <u:formField label="#{posRepBundle['PosRepSedeEmision']}:">

                                        <p:selectOneMenu id="posRepFiltrarSedeEmision" autoWidth="false"
                                                         value="#{posRepResultadoController.orgEstructuraSedeEmision}"
                                                         filter="true" filterMatchMode="contains" var="filtro">
                                            <f:selectItems
                                                    value="#{posRepResultadoController.orgEstructuraSedeEmisionList}"
                                                    var="orgEstructuraSedeEmisionItem"
                                                    itemValue="#{orgEstructuraSedeEmisionItem}"
                                                    itemLabel="#{orgEstructuraSedeEmisionItem.orgDescripcionEstructura.deeDescripcion.toString()}"
                                            />
                                            <p:column>
                                                <h:outputText
                                                        value="#{filtro.orgDescripcionEstructura.deeDescripcion}"/>
                                            </p:column>
                                            <p:ajax listener="#{posRepResultadoController.updateCampusEmisionList()}"
                                                    update="posRepFiltrarCampusEmision"/>
                                        </p:selectOneMenu>
                                    </u:formField>
                                </h:panelGroup>

                                <h:panelGroup id="campusEmision"
                                              rendered="#{repReportesSistemaController.selected ne null }">
                                    <!--Filtro Campus-->
                                    <u:formField label="#{posRepBundle['PosRepCampusEmision']}:">
                                        <p:selectOneMenu id="posRepFiltrarCampusEmision" autoWidth="false"
                                                         value="#{posRepResultadoController.orgEstructuraCampusEmision}"
                                                         filter="true" filterMatchMode="contains" var="filtro">
                                            <f:selectItems
                                                    value="#{posRepResultadoController.orgEstructuraCampusEmisionList}"
                                                    var="orgEstructuraCampusEmisionItem"
                                                    itemValue="#{orgEstructuraCampusEmisionItem}"
                                                    itemLabel="#{orgEstructuraCampusEmisionItem.orgDescripcionEstructura.deeDescripcion.toString()}"
                                            />
                                            <p:column>
                                                <h:outputText
                                                        value="#{filtro.orgDescripcionEstructura.deeDescripcion}"/>
                                            </p:column>
                                            <p:ajax update=""
                                                    listener="#{posRepResultadoController.updateCampusEmisionList()}"

                                            /><!--  -->
                                        </p:selectOneMenu>
                                    </u:formField>
                                </h:panelGroup>


                                <h:panelGrid id="certificacionPanel" columns="2" rendered="#{not empty posRepPosgradosController.insAlumnoWrapper and not empty posRepPosgradosController.posgradoAlumnoWrapper
                                                                     and ((posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION) and repReportesSistemaController.selected.resCodigo ne PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS)
                                                                     or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'S' ))
                                                                     }">
                                    <p:outputLabel value="#{posRepBundle['PosRepCertificar']} "/>
                                    <p:selectBooleanCheckbox value="#{posRepPosgradosController.certificacion}">
                                        <p:ajax update="PosCertificar"
                                                listener="#{repSecretarioGeneralController.obtenerListSecretariaCert()}"/>
                                    </p:selectBooleanCheckbox>

                                </h:panelGrid>

                                <!--Filtro SECRETARIA GENERAL-->
                                <h:panelGrid columns="2" id="PosCertificar" rendered="#{posRepPosgradosController.certificacion eq true
                                               and not empty posRepPosgradosController.insAlumnoWrapper
                                               and not empty posRepPosgradosController.posgradoAlumnoWrapper
                                               and ( (posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION) and repReportesSistemaController.selected.resCodigo ne PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS)
                                               or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'S' ))
                                               }">

                                    <u:formField label="#{posRepBundle['PosRepFirma']}:">

                                        <p:selectOneMenu id="posRepSecretarioGeneral" autoWidth="false"
                                                         value="#{repSecretarioGeneralController.secretarioSeleccionado}"
                                                         filter="true" filterMatchMode="contains" var="filtro"
                                        >
                                            <f:selectItems
                                                    value="#{repSecretarioGeneralController.listadoSecretariaGeneral}"
                                                    var="itemSecretario"
                                                    itemValue="#{itemSecretario}"
                                                    itemLabel="#{itemSecretario.segNombre}"
                                            />
                                            <p:column>
                                                <h:outputText value="#{filtro.segNombre}"/>
                                            </p:column>

                                        </p:selectOneMenu>
                                    </u:formField>

                                </h:panelGrid>
                            </u:grid>
                        </h:panelGroup>


                    </p:panel> <!--certificación-->
                </u:verticalStack>
            </u:card>


        </u:verticalStack>
    </h:form>

    <script>
        function start() {
            PF('statusDialog').show();
        }

        function stop() {
            PF('statusDialog').hide();
        }
    </script>
</ui:composition>