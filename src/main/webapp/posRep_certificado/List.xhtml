<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:us="http://ups.edu.ec/ui/security"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:o="http://omnifaces.org/ui">
    
    <f:metadata>
        <o:importConstants type="ec.edu.ups.pos.rep.data.utils.PosRepConstants" />
    </f:metadata>
    
    <h:form id="PosReportesCerForm">
        <p:panel header="#{posRepBundle['PosResultadosTitle2']}" id="RepCabecera">
            
            <p:growl id="notificacion" showDetail="true" sticky="false" life="7000"/>                          
            <h:panelGroup id="messagePanel">
                <p:messages id="listMessages" closable="true">
                    <p:effect type="pulsate" event="load" delay="200" speed="500">
                        <f:param name="times" value="1" />
                    </p:effect>
                </p:messages>
            </h:panelGroup>                   
            
                 <p:dataTable id="PosReportesCerSistemaDataTable"
                         widgetVar="PosReportesCerSistemaDataTableVar"
                         value="#{repReportesSistemaController.items}"
                         var="item"
                         rowKey="#{item.resCodigo}"
                         sortBy="#{item.resReporte}"
                         sortOrder="ascending"
                         paginator="true"
                         rows="10"
                         rowsPerPageTemplate="10,20,30,40,50"
                         selectionMode="single"
                         paginatorPosition="bottom"
                         emptyMessage="#{pedBundle['TableEmpty']}"
                         selection="#{repReportesSistemaController.selected}"
                         filteredValue="#{repReportesSistemaController.itemsFilter}">
                <p:ajax event="rowSelect" update=":PosReportesCerForm:PosRepCerExportToolbar, 
                                                  :PosReportesCerForm:PosRepFiltroPanel,
                                                  :PosReportesCerForm:messagePanel,
                                                  :PosReportesCerForm:alumno,                                                  
                                                  :PosReportesCerForm:semestre
                                                  :PosReportesCerForm:panelDataTable,
                                                  :PosReportesCerForm:PosRepFiltroPanel2,
                                                  :PosReportesCerForm:posRepFiltrarCampusEmision,
                                                  :PosReportesCerForm:posRepFiltrarSedeEmision"
                                                  listener="#{posRepPosgradosController.limpiarFiltros()}"/>
                
                <p:ajax event="filter" update=":PosReportesCerForm:PosRepCerExportToolbar,
                                                :PosReportesCerForm:PosRepFiltroPanel,
                                                :PosReportesCerForm:messagePanel,
                                                  :PosReportesCerForm:alumno,
                                                  :PosReportesCerForm:semestre,
                                                  :PosReportesCerForm:panelDataTable,
                                                  :PosReportesCerForm:PosRepFiltroPanel2
                                                  :PosReportesCerForm:posRepFiltrarCampusEmision,
                                                  :PosReportesCerForm:posRepFiltrarSedeEmision" listener="#{repReportesSistemaController.setSelected(null)}"/>                 
                
                <p:column sortBy="#{item.resReporte}" filterBy="#{item.resReporte}" filterMatchMode="contains">
                    <f:facet name="header">
                        <h:outputText value="#{posRepBundle['RepReportesSistemaLabel_resReporte']}"/>
                    </f:facet>        
                    <h:outputText value="#{item.resReporte}"/>
                </p:column>                                 
                
                <p:column sortBy="#{item.resFormato}" styleClass="columnFormato">
                    <f:facet name="header">
                        <h:outputText value="#{posRepBundle['RepReportesSistemaLabel_resFormato']}"/>
                    </f:facet>
                    <h:outputText value="#{item.resFormato}"/>
                </p:column>        
            </p:dataTable>
 
             <p:panel id="PosRepFiltroPanel" header="Parámetros Generales">
                   <h:panelGroup id="alumno">
                    <ui:fragment rendered="#{repReportesSistemaController.selected ne null 
                                             and posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_ALUMNO)}">
                        <!--Filtro Estudiante-->
                        <ui:decorate template="/WEB-INF/templates/decorators/search/ups-search-param.xhtml">
                            <ui:define name="ups-search-param-title">  
                                <p:outputLabel value="#{posRepBundle['PosRepEstudiante']}:" />                        
                            </ui:define>

                            <ui:define name="ups-search-param-content">
                                <h:panelGroup id="posRepFiltrarEstudiante">
                                    <p:autoComplete id="posRepFiltrarEstudiante2" value="#{posRepPosgradosController.insAlumnoWrapper}"                                
                                                    cache="true" forceSelection="true" maxResults="10" minQueryLength="2" cacheTimeout="30000"
                                                   var="p" 
                                                   itemLabel="#{not empty p?p.cllcRuc:''}#{not empty p?' - ':''}#{not empty p?p.aluNombres:''}" 
                                                    itemValue="#{p}" 
                                                   
                                                 
                                                    autocomplete="on"
                                                    completeMethod="#{posRepPosgradosController.autoCompleteAlumnos}"
                                                    queryDelay="0"                                                                      
                                                    > 
                                        <o:converter converterId="omnifaces.ListConverter" list="#{posRepPosgradosController.listadoAlumnos}" />

                                           <p:column>
                                           <h:outputText value="#{p.cllcRuc}" />
                                           </p:column>
                                           <p:column>
                                               <h:outputText value="#{p.aluNombres}"/>
                                           </p:column>                                                     
                                        <p:ajax event=  "itemSelect" update="panelDataTable,semestre,PosRepFiltroPanel2, messagePanel,posRepFiltrarCampusEmision, posRepFiltrarSedeEmision"  
                                                 listener="#{posRepPosgradosController.cargarLista()}"/>
                                        <p:ajax event=  "change" update="panelDataTable,semestre,PosRepFiltroPanel2, messagePanel,posRepFiltrarCampusEmision, posRepFiltrarSedeEmision"  
                                                 listener="#{posRepPosgradosController.cargarLista()}"/>
                                         
                                    </p:autoComplete>   
                                    <p:watermark value="Escriba nombre o apellido del estudiante, caso contrario será Todos." for="posRepFiltrarEstudiante2" />
                   
                                </h:panelGroup>
                            </ui:define>
                        </ui:decorate>
                    </ui:fragment>
                </h:panelGroup>
            
           <h:panelGroup id="semestre">
                    <ui:fragment rendered="#{repReportesSistemaController.selected ne null 
                                             and posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_SEMESTRE)
                                             and not empty posRepPosgradosController.insAlumnoWrapper}">
                       
                        <ui:decorate template="/WEB-INF/templates/decorators/search/ups-search-param.xhtml">
                            <ui:define name="ups-search-param-title">  
                                <p:outputLabel value="#{posRepBundle['PosRepSemestre']}: *" for="posRepFiltrarNivel" />                        
                            </ui:define>

                            <ui:define name="ups-search-param-content">
                                <p:selectOneMenu id="posRepFiltrarNivel" value="#{posRepPosgradosController.matNivelPeriodoEstructura}" filter="true" filterMatchMode="contains" var="filtro" 
                                                      > 
<!--                                                 required="true" requiredMessage="Seleccione el Semestre."                                     -->
                                                                                 
                                         <!--<f:selectItem itemLabel="#{posRepBundle['Todos']}" itemValue=""/>-->
                                         <f:selectItem itemLabel="#{posRepBundle['SelectOneMessage']}" itemValue=""/>
                                         <f:selectItems value="#{posRepPosgradosController.matNivelPeriodoEstructuraList}"
                                                        var="nivelMatriculaItem"
                                                        itemValue="#{nivelMatriculaItem}"
                                                        itemLabel="#{nivelMatriculaItem.toString()}"
                                                        />                            
                                         <p:column>
                                             <h:outputText value="#{filtro}" />  
                                         </p:column>
                                         <p:ajax update="PosRepFiltroPanel2, messagePanel" listener="#{posRepPosgradosController.actualizaCamposFac()}" />
                                      
                                     </p:selectOneMenu>                        
                                 </ui:define>
                        </ui:decorate>
                    </ui:fragment>
                </h:panelGroup>   
        
         <h:panelGrid id="panelDataTable">          
          <p:dataTable id="PosgradosDataTable"
                         widgetVar="PosgradosDataTableVar"
                         value="#{posRepPosgradosController.listadoPosgrados}"
                         var="item"
                         rowKey="#{item.identificador}"
                         sortBy="#{item.aluCodigo}"
                         sortOrder="ascending"
                         paginator="true"                         
                         rows="10" 
                         rowsPerPageTemplate="10,20,30,40,50"  
                         selectionMode="single"
                         selection ="#{posRepPosgradosController.posgradoAlumnoWrapper}"
                         paginatorPosition="bottom"                                                  
                         emptyMessage="#{posRepBundle['TableEmpty']}"
                         rendered="#{posRepPosgradosController.insAlumnoWrapper ne null}"
                    >          
              <p:ajax event="rowSelect" listener="#{posRepPosgradosController.cargarValidaciones(repReportesSistemaController.selected)}" update=":PosReportesCerForm:semestre,:PosReportesCerForm:PosRepFiltroPanel2,:PosReportesCerForm:PosRepCerExportToolbar, 
                                                                                                                                                    :PosReportesCerForm:messagePanel, :PosReportesCerForm:posRepFiltrarCampusEmision,:PosReportesCerForm:posRepFiltrarSedeEmision" />
              
               <p:column>
                    <f:facet name="header">
                        <h:outputText value="Sede"/>
                    </f:facet>
                    <h:outputText value="#{item.sede}" />
                </p:column>
                <p:column>
                    <f:facet name="header">               
                        <h:outputText value="Campus"/>
                    </f:facet>
                    <h:outputText value="#{item.campus}" />
                    
                </p:column>
              <p:column width="20%">
                    <f:facet name="header">
                        <h:outputText value="Programa"/>
                    </f:facet>
                    <h:outputText value="#{item.posgrado}" />
                </p:column>
                 <p:column width="20%">
                    <f:facet name="header">
                        <h:outputText value="Proyecto"/>
                    </f:facet>
                    <h:outputText value="#{item.proyecto}" />
                </p:column>
                  <p:column>
                    <f:facet name="header">
                        <h:outputText value="Modalidad"/>
                    </f:facet>
                    <h:outputText value="#{item.modalidad}" />
                </p:column>
                <p:column width="14%">
                    <f:facet name="header">               
                        <h:outputText value="Cohorte"/>
                    </f:facet>
                    <h:outputText value="#{item.cohorte}" />
                </p:column>
                <p:column width="20%">
                    <f:facet name="header">
                        <h:outputText value="Título"/>
                    </f:facet>
                    <h:outputText value="#{item.titulo}" />
                </p:column>
                 <p:column width="5%">
                    <f:facet name="header">
                        <h:outputText value="Vigencia"/>
                    </f:facet>
                    <h:outputText value="#{item.vigencia}" />
                </p:column>                        
            </p:dataTable>       
           <br/>       
         </h:panelGrid> 
       </p:panel>                       	

<!--CERTIFICACIÓN -->    
<p:panel id="PosRepFiltroPanel2" header="Certificación de Rúbricas" >    
         <h:panelGrid id="datosfactura" columns="3" cellpadding="5" rendered="#{not empty posRepPosgradosController.insAlumnoWrapper 
                                                                                and not empty posRepPosgradosController.posgradoAlumnoWrapper 
                                                                                and ( (posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION) and repReportesSistemaController.selected.resCodigo ne PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS) 
                                                                                or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'S' ))
                                                                                }" >  

              <p:outputLabel value="#{posRepBundle['PosRepSede']}:"  for="sedeFacturacion" /> 
              <p:outputLabel value="#{posRepBundle['PosRepPuntoFac']}:" for="puntoFacturacion"/>
              <p:outputLabel value="#{posRepBundle['PosRepNumFac']}:" for="numFactura"/>
              
              <p:inputText id="sedeFacturacion" value="#{posRepPosgradosController.sedeFactura}" required="true" style=" text-align: right; width: 80%"   requiredMessage="Ingrese la sede de Facturación."/>
              <p:inputText id="puntoFacturacion" value="#{posRepPosgradosController.puntoFacturacion}" required="true" style=" text-align: right; width: 80%"   requiredMessage="Ingrese el punto de Facturación."/>
              <p:inputText id="numFactura" value="#{posRepPosgradosController.numFactura}" required="true" style=" text-align: right; width: 80%"   requiredMessage="Ingrese el número de Factura."/>
           
            
             <h:panelGroup id="sedeEmision">
                    <ui:fragment rendered="#{repReportesSistemaController.selected ne null }">
                        <!--Filtro Sede-->
                        <ui:decorate template="/WEB-INF/templates/decorators/search/ups-search-param.xhtml">
                            <ui:define name="ups-search-param-title">
                                <p:outputLabel value="#{posRepBundle['PosRepSedeEmision']}:" />                        
                           </ui:define>
                            <ui:define name="ups-search-param-content">                       
                                <p:selectOneMenu id="posRepFiltrarSedeEmision" 
                                                 value="#{posRepResultadoController.orgEstructuraSedeEmision}"                                         
                                                 filter="true" filterMatchMode="contains" var="filtro">                                                        
                                    <!-- <f:selectItem itemLabel="#{posRepBundle['Todos']}" itemValue="" itemDisabled="#{posRepResultadoController.validaSeleccionEstructuraSeguridadSede}"/> -->
                                    <f:selectItem itemLabel="#{posRepBundle['Todos']}" itemValue="" itemDisabled="#{posRepResultadoController.validaSeleccionEstructuraSeguridadSede}"/>
                                    <f:selectItems value="#{posRepResultadoController.orgEstructuraSedeEmisionList}"
                                                   var="orgEstructuraSedeEmisionItem"
                                                   itemValue="#{orgEstructuraSedeEmisionItem}"
                                                   itemLabel="#{orgEstructuraSedeEmisionItem.orgDescripcionEstructura.deeDescripcion.toString()}"
                                                   />
                                    <p:column>
                                        <h:outputText value="#{filtro.orgDescripcionEstructura.deeDescripcion}" />  
                                    </p:column>
                                    <p:ajax listener="#{posRepResultadoController.updateCampusEmisionList()}" 
                                            update="posRepFiltrarCampusEmision"/>
                                </p:selectOneMenu>
                            </ui:define>
                        </ui:decorate>  
                    </ui:fragment>
                </h:panelGroup>
                
                <h:panelGroup id="campusEmision">
                    <ui:fragment rendered="#{repReportesSistemaController.selected ne null }">
                        <!--Filtro Campus-->
                        <ui:decorate template="/WEB-INF/templates/decorators/search/ups-search-param.xhtml">
                            <ui:define name="ups-search-param-title">
                                <p:outputLabel value="#{posRepBundle['PosRepCampusEmision']}:" />                        
                            </ui:define>
                            <ui:define name="ups-search-param-content">
                                <p:selectOneMenu id="posRepFiltrarCampusEmision" 
                                                 value="#{posRepResultadoController.orgEstructuraCampusEmision}" 
                                                 filter="true" filterMatchMode="contains" var="filtro" >                                                        
                                    <f:selectItem itemLabel="#{posRepBundle['Todos']}" itemValue="" itemDisabled="#{posRepResultadoController.validaSeleccionEstructuraSeguridadCampus}"/>
                                    <f:selectItems value="#{posRepResultadoController.orgEstructuraCampusEmisionList}"
                                                   var="orgEstructuraCampusEmisionItem"
                                                   itemValue="#{orgEstructuraCampusEmisionItem}"
                                                   itemLabel="#{orgEstructuraCampusEmisionItem.orgDescripcionEstructura.deeDescripcion.toString()}"
                                                   />
                                    <p:column>
                                        <h:outputText value="#{filtro.orgDescripcionEstructura.deeDescripcion}" />  
                                    </p:column>   
                                    <p:ajax update=""                                    
                                            listener="#{posRepResultadoController.updateCampusEmisionList()}" 
                                            
                                            
                                            /><!--  -->
                                </p:selectOneMenu>
                            </ui:define>
                        </ui:decorate>
                    </ui:fragment>
                </h:panelGroup>    
        </h:panelGrid> 
         <br/> 
        <h:panelGrid id="certificacionPanel" columns="2" rendered="#{not empty posRepPosgradosController.insAlumnoWrapper and not empty posRepPosgradosController.posgradoAlumnoWrapper 
                                                                     and ((posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION) and repReportesSistemaController.selected.resCodigo ne PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS) 
                                                                     or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'S' ))
                                                                     }" >   
              <p:outputLabel value="#{posRepBundle['PosRepCertificar']} " />
              <p:selectBooleanCheckbox value="#{posRepPosgradosController.certificacion}" >
                  <p:ajax update="PosCertificar" listener="#{repSecretarioGeneralController.obtenerListSecretariaCert()}" />
              </p:selectBooleanCheckbox>
              
        </h:panelGrid>        
    
            <!--Filtro SECRETARIA GENERAL-->
        <h:panelGrid columns="2" id="PosCertificar"  >
                                 
                      <ui:fragment rendered="#{posRepPosgradosController.certificacion eq true  
                                               and not empty posRepPosgradosController.insAlumnoWrapper 
                                               and not empty posRepPosgradosController.posgradoAlumnoWrapper 
                                               and ( (posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION) and repReportesSistemaController.selected.resCodigo ne PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS) 
                                               or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'S' ))                             
                                               }" >
                          <ui:decorate template="/WEB-INF/templates/decorators/search/ups-search-param.xhtml">
                            <ui:define name="ups-search-param-title">  
                                <p:outputLabel value="#{posRepBundle['PosRepFirma']}:"  />   
                                
                            </ui:define>

                            <ui:define name="ups-search-param-content">
                                <p:selectOneMenu id="posRepSecretarioGeneral" value="#{repSecretarioGeneralController.secretarioSeleccionado}"                                         
                                                      filter="true" filterMatchMode="contains" var="filtro" 
                                                      >                            
                                         <!--<f:selectItem itemLabel="#{posRepBundle['SelectOneMessage']}" itemValue=""/>-->
                                         <f:selectItems value="#{repSecretarioGeneralController.listadoSecretariaGeneral}"
                                                        var="itemSecretario"
                                                        itemValue="#{itemSecretario}"
                                                        itemLabel="#{itemSecretario.segNombre}"
                                                        />                            
                                         <p:column>
                                             <h:outputText value="#{filtro.segNombre}" />  
                                         </p:column>
                           
                                     </p:selectOneMenu>                        
                                 </ui:define>
                        </ui:decorate>
                    </ui:fragment>      
            </h:panelGrid>   
             
       </p:panel> <!--certificación-->           
       </p:panel>
        
        <p:toolbar id="PosRepCerExportToolbar">
            <us:auth permissions="{'operations':['GENERAR']}">
                
                <p:toolbarGroup align="center" >           
                    
                    <p:commandLink id="nonAjaxExcel"                                    
                                   ajax="false"
                                   update="messagePanel"     
                                   process="@this" 
                                   onclick="PrimeFaces.monitorDownload(start, stop);"
                                   disabled="#{repReportesSistemaController.selected.resFormato eq null or (repReportesSistemaController.selected.resFormato ne 'EXCEL' and repReportesSistemaController.selected.resFormato ne 'PDF - EXCEL')}">  
                        <p:graphicImage library="ups-template" 
                                        name="images/icons/apps/xls.png" 
                                        alt="#{posRepBundle['ExportXls']}" 
                                        title="#{posRepBundle['ExportXls']}"/>  
                        <p:fileDownload value="#{posRepGeneralController.generar_reporte_certificado('xlsx',posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION))}"  />
                    </p:commandLink>
                    
                    <p:commandLink id="nonAjaxPdf"                                    
                                   ajax="false" 
                                   update="messagePanel"
                                   process="@this"    
                                   onclick="PrimeFaces.monitorDownload(start, stop);"
                                   disabled="#{repReportesSistemaController.selected.resFormato eq null or (repReportesSistemaController.selected.resFormato ne 'PDF' and repReportesSistemaController.selected.resFormato ne 'PDF - EXCEL')  
                                               or empty posRepPosgradosController.insAlumnoWrapper 
                                               or empty posRepPosgradosController.posgradoAlumnoWrapper 
                                               or (repReportesSistemaController.selected.resCodigo eq PosRepConstants.REPORTE_SISTEMA_RECORD_ACADEMICO_GRADUADOS and posRepPosgradosController.posgradoAlumnoWrapper.actaGrado eq 'N')
                                               }"   >
                        <p:graphicImage library="ups-template" 
                                        name="images/icons/apps/pdf.png" 
                                        alt="#{posRepBundle['ExportPdf']}" 
                                        title="#{posRepBundle['ExportPdf']}"/>  
                        <p:fileDownload value="#{posRepGeneralController.generar_reporte_certificado('pdf',posRepPosgradosController.compruebaParametro(repReportesSistemaController.selected, PosRepConstants.REP_PARAMETRO_CERTIFICACION))}" />
                    </p:commandLink>                                        
                    
                              
                </p:toolbarGroup>

            </us:auth>
        </p:toolbar>   
    </h:form>
    
  <script>
     function start() {
         PF('statusDialog').show();
     }

     function stop() {
         PF('statusDialog').hide();
     }
  </script>   
</ui:composition>